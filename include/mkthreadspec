#!/bin/sh

if [ $# -ne 1 ]
then
  echo Usage: mkthreadspec \"how to preprocess C code\"
  echo For example: mkthreadspec \"gcc -E\"
  exit 1
fi

CPP="$1"

(
  grep -v '#[ \t]*include' gthread.h
  echo 'mkthreadspec: Using thread system GTHREAD_SYSTEM_NAME'
  echo '#ifdef main'
  echo '#ifdef Thread'
  echo '#undef Thread'
  echo '#endif'
  echo 'mkthreadspec: Thread-specific definition: NAIM is defined to main'
  echo '#else'
  echo 'mkthreadspec: No thread-specific definitions.'
  echo '#endif'
) > ts_temp.c

$CPP ts_temp.c | grep '^mkthreadspec:' | sed 's/NAIM/main/' > ts_temp.i
cat ts_temp.i    # I could do this with tee, but this is a tad more portable.

(
  echo '/* Macros specific to the thread system that must be included by the user.'
  echo ' * This file is included by mpi.h.'
  echo ' * This file is automatically generated by mkthreadspec.'
  echo ' */'
  echo
  grep 'main is defined to' ts_temp.i | sed 's/.*main is defined to/#define main/'
) > threadspec.h

rm -f ts_temp.c ts_temp.i
